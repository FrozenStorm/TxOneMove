<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TxOneMove</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-compass/dist/leaflet-compass.min.css" />
    <script src="https://unpkg.com/leaflet-control-compass/dist/leaflet-compass.min.js"></script>
    <style>
        :root{
        --bg0:#070A10;
        --bg1:#0B1220;
        --surface:rgba(255,255,255,.06);
        --surface-2:rgba(255,255,255,.09);
        --border:rgba(255,255,255,.12);
        --text:rgba(255,255,255,.92);
        --muted:rgba(255,255,255,.62);
        --accent:#FF5A2A;
        --accent-2:#00D4FF;
        --success:#27D17C;
        --danger:#FF4D4F;
        --shadow: 0 18px 40px rgba(0,0,0,.45);
        --radius:14px;
        --radius-sm:12px;
        --focus: 0 0 0 3px rgba(0,212,255,.22);
        }

        *{ box-sizing:border-box; }
        html, body{ height:100%; }

        body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        color:var(--text);
        background:
            radial-gradient(900px 520px at 10% -10%, rgba(0,212,255,.18), transparent 55%),
            radial-gradient(800px 520px at 90% 0%, rgba(255,90,42,.16), transparent 55%),
            linear-gradient(180deg, var(--bg0), var(--bg1));
        }

        .topbar{
        position: sticky;
        top: 0;
        z-index: 20;
        background: rgba(7,10,16,.65);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        }

        .brand{
        max-width: 1400px;
        margin: 0 auto;
        padding: 14px 16px;
        display:flex;
        align-items:center;
        gap:12px;
        justify-content: space-between;
        }

        .brand-mark{
        width: 14px;
        height: 14px;
        border-radius: 999px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: 0 0 0 3px rgba(255,255,255,.06);
        }

        .brand-title{
        font-weight: 800;
        letter-spacing: .02em;
        }

        .brand-sub{
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
        }

        .vario-controls{
        display: flex;
        align-items: center;
        gap: 12px;
        }

        .vario-btn{
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.08);
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all .2s ease;
        }

        .vario-btn:hover{
        background: rgba(255,255,255,.12);
        filter: brightness(1.1);
        }

        .vario-btn.active{
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border-color: rgba(255,255,255,.2);
        }

        .vario-info{
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        }

        .vario-value{
        font-size: 18px;
        font-weight: 800;
        color: rgba(255,255,255,.95);
        }

        .vario-label{
        font-size: 10px;
        color: var(--muted);
        letter-spacing: .08em;
        text-transform: uppercase;
        }

        .container{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
        padding: 16px;
        max-width: 1400px;
        margin: 0 auto;
        }

        @media (max-width: 1024px){
        .container{ grid-template-columns:1fr; }
        }

        .panel{
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        }

        .panel h2{
        margin: 0 0 14px 0;
        font-size: 12px;
        letter-spacing: .14em;
        text-transform: uppercase;
        color: rgba(255,255,255,.78);
        font-weight: 800;
        }

        #map{
        height: 420px;
        border-radius: var(--radius-sm);
        overflow:hidden;
        border: 1px solid var(--border);
        }

        .leaflet-control, .leaflet-bar a{
        background: rgba(10,16,28,.75) !important;
        color: var(--text) !important;
        border-color: rgba(255,255,255,.14) !important;
        }
        .leaflet-container{
        background: rgba(10,16,28,.8);
        }

        .horizon{
        height: 220px;
        border-radius: var(--radius-sm);
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border);
        background:
            linear-gradient(180deg,
            rgba(0,212,255,.18) 0%,
            rgba(0,212,255,.06) 48%,
            rgba(255,90,42,.08) 52%,
            rgba(255,90,42,.03) 100%);
        }

        .horizon-needle{
        position:absolute;
        inset:0;
        display:flex;
        align-items:center;
        justify-content:center;
        transition: transform 0.08s linear;
        }

        .horizon-line{
        width: 84%;
        height: 2px;
        background: rgba(255,255,255,.9);
        box-shadow: 0 0 0 1px rgba(0,0,0,.35);
        border-radius: 2px;
        }

        .horizon-marker{
        position:absolute;
        width:2px;
        height:46px;
        background: rgba(255,255,255,.9);
        top:50%;
        left:50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 0 1px rgba(0,0,0,.35);
        }

        .controls{ display:flex; flex-direction:column; gap: 12px; }

        .control-group{
        border: 1px solid rgba(255,255,255,.12);
        border-radius: var(--radius-sm);
        padding: 12px;
        background: rgba(255,255,255,.04);
        }

        .control-group label{
        display:block;
        font-size: 11px;
        letter-spacing: .12em;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 800;
        margin-bottom: 8px;
        }

        input[type="number"], select{
        width: 100%;
        padding: 10px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(10,16,28,.55);
        color: var(--text);
        outline: none;
        }

        input[type="number"]:focus, select:focus{
        box-shadow: var(--focus);
        border-color: rgba(0,212,255,.45);
        }

        input[type="range"]{
        width: 100%;
        cursor: pointer;
        accent-color: var(--accent);
        }

        button{
        padding: 11px 14px;
        border: 1px solid rgba(255,255,255,.12);
        color: rgba(255,255,255,.95);
        background: linear-gradient(135deg, rgba(255,90,42,.95), rgba(255,90,42,.70));
        border-radius: 12px;
        cursor: pointer;
        font-weight: 800;
        letter-spacing: .02em;
        transition: transform .12s ease, filter .12s ease, background .2s ease;
        }

        button:hover{ filter: brightness(1.05); transform: translateY(-1px); }
        button:active{ transform: translateY(0px); }
        button:disabled{ opacity: .5; cursor: not-allowed; transform:none; }

        .status{
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,.12);
        font-weight: 800;
        text-align: center;
        background: rgba(255,255,255,.04);
        }

        .status.connected{
        border-color: rgba(39,209,124,.30);
        background: rgba(39,209,124,.10);
        color: var(--success);
        }

        .status.disconnected{
        border-color: rgba(255,77,79,.30);
        background: rgba(255,77,79,.10);
        color: var(--danger);
        }

        .telemetry-grid{
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin: 14px 0 0 0;
        }

        .telemetry-grid-single{
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 14px 0 0 0;
        }

        .telemetry-item{
        background: rgba(255,255,255,.04);
        border: 1px solid rgba(255,255,255,.12);
        border-radius: var(--radius-sm);
        padding: 12px;
        position: relative;
        overflow:hidden;
        }

        .telemetry-item::before{
        content:"";
        position:absolute;
        inset:0;
        background: radial-gradient(300px 120px at 0% 0%, rgba(0,212,255,.10), transparent 60%);
        pointer-events:none;
        }

        .telemetry-label{
        font-size: 11px;
        letter-spacing: .12em;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 800;
        }

        .telemetry-value{
        margin-top: 6px;
        font-size: 22px;
        font-weight: 900;
        color: rgba(255,255,255,.95);
        }

        .heading-arrow{
        position:absolute;
        width:0;
        height:0;
        border-left: 14px solid transparent;
        border-right: 14px solid transparent;
        border-bottom: 28px solid var(--accent);
        top: 64px;
        left: 50%;
        transform: translateX(-50%);
        filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
        transition: transform .08s linear;
        }

        #debugLog{
        height: 200px;
        overflow-y: auto;
        background: rgba(10,16,28,.55) !important;
        border: 1px solid rgba(255,255,255,.12);
        border-radius: 12px !important;
        padding: 10px !important;
        color: rgba(255,255,255,.86);
        }

        .vario-panel{
        grid-column: 1 / -1;
        }

        .vario-status{
        display: flex;
        justify-content: space-around;
        margin-top: 12px;
        }

        .vario-status-item{
        text-align: center;
        padding: 12px;
        background: rgba(255,255,255,.04);
        border: 1px solid rgba(255,255,255,.12);
        border-radius: var(--radius-sm);
        flex: 1;
        }

        .vario-status-value{
        font-size: 28px;
        font-weight: 900;
        margin: 8px 0;
        }

        .vario-status-value.sink{
        color: var(--danger);
        }

        .vario-status-value.climb{
        color: var(--success);
        }

        .vario-status-value.neutral{
        color: var(--muted);
        }

        .vario-status-label{
        font-size: 10px;
        color: var(--muted);
        letter-spacing: .08em;
        text-transform: uppercase;
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><circle cx='96' cy='96' r='90' fill='%232196F3'/><path d='M96,40 L130,140 L96,110 L62,140 Z' fill='white'/></svg>">
</head>
<body>
    <header class="topbar">
        <div class="brand">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="brand-mark"></div>
                <div class="brand-text">
                    <div class="brand-title">TxOneMove</div>
                    <div class="brand-sub">Telemetry ‚Ä¢ BLE ‚Ä¢ Vario</div>
                </div>
            </div>
            <!-- VARIO CONTROLS IN TOPBAR -->
            <div class="vario-controls">
                <button class="vario-btn" id="varioToggleBtn" onclick="toggleVario()" title="Vario abspielen/pausieren">üîä</button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="20" onchange="setVolume()" style="width: 80px; height: 24px; accent-color: var(--accent); cursor: pointer; margin: 0 8px;">
                <div class="vario-info">
                    <div class="vario-value" id="varioSpeedDisplay">0.0</div>
                    <div class="vario-label">m/s</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Verbindung und Status -->
        <div class="panel">
            <h2>üîå Verbindung</h2>
            <div class="status disconnected" id="status">Getrennt</div>
            <button onclick="connectBLE()" id="connectBtn" style="margin-top: 12px; width: 100%;">Verbinden</button>
            <button onclick="disconnectBLE()" id="disconnectBtn" style="margin-top: 8px; width: 100%; display: none;">Trennen</button>
            <button onclick="resetTrim()" id="resetTrimBtn" style="margin-top: 8px; width: 100%; display: none; background: linear-gradient(135deg, var(--accent-2), rgba(0,212,255,.7));">
                üîÑ Reset Trim
            </button>
        </div>

        <!-- Karte und Position & Heading -->
        <div class="panel">
            <h2>üó∫Ô∏è Position & Heading</h2>
            <div id="map"></div>
            <div class="heading-arrow" id="headingArrow"></div>
            <div class="telemetry-grid" style="margin-top: 12px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                <div class="telemetry-item">
                    <div class="telemetry-label">Breitengrad</div>
                    <div class="telemetry-value" id="telem-lat">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">L√§ngengrad</div>
                    <div class="telemetry-value" id="telem-lon">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Heading</div>
                    <div class="telemetry-value" id="telem-heading">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">HDOP</div>
                    <div class="telemetry-value" id="telem-hdop">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Satellites</div>
                    <div class="telemetry-value" id="telem-satellites">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Altitude</div>
                    <div class="telemetry-value" id="telem-gps_saltitude">--</div>
                </div>
            </div>
        </div>

        <!-- Tx Data -->
        <div class="panel">
            <h2>üì° Tx Data</h2>
            <div class="telemetry-grid" id="txDataGrid">
                <div class="telemetry-item">
                    <div class="telemetry-label">Armed</div>
                    <div class="telemetry-value" id="telem-armed">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Tx Spannung</div>
                    <div class="telemetry-value" id="telem-tx_voltage">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Throttle</div>
                    <div class="telemetry-value" id="telem-throttle_voltage">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Pitch</div>
                    <div class="telemetry-value" id="telem-pitch">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Roll</div>
                    <div class="telemetry-value" id="telem-roll">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Throttle</div>
                    <div class="telemetry-value" id="telem-throttle">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Trim Pitch</div>
                    <div class="telemetry-value" id="telem-trim_pitch">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Trim Roll</div>
                    <div class="telemetry-value" id="telem-trim_roll">--</div>
                </div>
            </div>
        </div>

        <!-- RX Telemetry -->
        <div class="panel">
            <h2>üì∂ RX Telemetry</h2>
            <div class="telemetry-grid">
                <div class="telemetry-item">
                    <div class="telemetry-label">Rx Spannung</div>
                    <div class="telemetry-value" id="telem-rx_voltage">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Altitude</div>
                    <div class="telemetry-value" id="telem-altitude">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Max. Altitude</div>
                    <div class="telemetry-value" id="telem-max_altitude">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Steigrate</div>
                    <div class="telemetry-value" id="telem-v_speed">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Vario Status</div>
                    <div class="telemetry-value" id="telem-v_status">--</div>
                </div>
            </div>
        </div>

        <!-- Horizont -->
        <div class="panel">
            <h2>üéØ Horizont</h2>
            <div class="horizon">
                <div class="horizon-needle" id="horizonNeedle">
                    <div class="horizon-line"></div>
                </div>
                <div class="horizon-marker"></div>
            </div>
        </div>

        <!-- Parameter-Kontrollen -->
        <div class="panel">
            <h2>‚öôÔ∏è Parameter</h2>
            <div class="controls" id="controlsContainer"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <button onclick="saveParams()" style="width: 100%; background: linear-gradient(135deg, var(--success), rgba(39,209,124,.7));">
                üíæ Save
                </button>
            </div>
        </div>

        <!-- Debug-Log -->
        <div class="panel">
            <h2>üìù Log</h2>
            <div id="debugLog" style="height: 200px; overflow-y: auto; background: rgba(10,16,28,.55); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 10px; color: rgba(255,255,255,.86);">
                Bereit...
            </div>
        </div>
    </div>

    <script>
        // ============ AUDIO & VARIO ============
        let audioCtx = null;
        let wakeLock = null;
        let varioActive = false;
        let sinkOscillator = null;
        let sinkGainNode = null;
        let varioVolume = 0.1;
        let lastClimbToneTime = 0;

        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                addLog('‚úì AudioContext initialisiert');
            }
        }

        function setVolume() {
            const slider = document.getElementById('volumeSlider');
            varioVolume = parseFloat(slider.value) / 100;
            if (sinkGainNode) {
                sinkGainNode.gain.setValueAtTime(varioVolume, audioCtx.currentTime);
            }
            addLog('üîä Lautst√§rke: ' + slider.value + '%');
        }

        function playClimbTone(frequency, interval) {
            if (!varioActive || !audioCtx) return;

            const now = Date.now();
            if (now - lastClimbToneTime < interval) return;
            lastClimbToneTime = now;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            oscillator.type = 'sine';
            
            // Kurzer Puls f√ºr Steigen
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(varioVolume, audioCtx.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.15);
        }

        function startSinkTone(frequency) {
            if (!varioActive || !audioCtx) return;
            if (sinkOscillator) return;  // Bereits am Laufen

            sinkOscillator = audioCtx.createOscillator();
            sinkGainNode = audioCtx.createGain();
            
            sinkOscillator.connect(sinkGainNode);
            sinkGainNode.connect(audioCtx.destination);
            
            sinkOscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            sinkOscillator.type = 'sine';
            sinkGainNode.gain.setValueAtTime(varioVolume, audioCtx.currentTime);
            
            sinkOscillator.start(audioCtx.currentTime);
        }

        function updateSinkFrequency(frequency) {
            if (sinkOscillator) {
                sinkOscillator.frequency.setTargetAtTime(frequency, audioCtx.currentTime, 0.05);
            }
        }

        function stopSinkTone() {
            if (sinkOscillator) {
                sinkGainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                sinkOscillator.stop(audioCtx.currentTime + 0.1);
                sinkOscillator = null;
                sinkGainNode = null;
            }
        }

        function updateVarioSound(v_speed, v_min, v_max) {
            if (!varioActive) return;
            
            // Totzone: wenn innerhalb ¬±v_min, nichts spielen
            if (Math.abs(v_speed) < v_min) {
                stopSinkTone();
                return;
            }
            
            if (v_speed > 0) {
                // STEIGEN: kurze Piept√∂ne mit h√∂herer Frequenz
                stopSinkTone();
                const ratio = Math.min(v_speed / v_max, 1.0);
                const frequency = 400 + (ratio * 1600);  // 400-2000 Hz
                const interval = 200 - (ratio * 150);  // 200-50 ms
                playClimbTone(frequency, interval);
            } else {
                // SINKEN: durchgehender Ton mit wechselnder Frequenz
                const ratio = Math.min(Math.abs(v_speed) / v_max, 1.0);
                const frequency = 400 - (ratio * 250);  // 400-150 Hz
                
                if (!sinkOscillator) {
                    startSinkTone(frequency);
                } else {
                    updateSinkFrequency(frequency);
                }
            }
        }

        function toggleVario() {
            const btn = document.getElementById('varioToggleBtn');
            varioActive = !varioActive;
            
            if (varioActive) {
                initAudioContext();
                btn.classList.add('active');
                requestWakeLock();
                addLog('üîä Vario aktiviert');
            } else {
                btn.classList.remove('active');
                stopSinkTone();
                releaseWakeLock();
                addLog('‚è∏Ô∏è Vario pausiert');
            }
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator && !wakeLock) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    addLog('‚úì Wake Lock aktiviert (Vario im Hintergrund)');
                }
            } catch (error) {
                addLog('‚ö†Ô∏è Wake Lock nicht verf√ºgbar: ' + error.message);
            }
        }

        async function releaseWakeLock() {
            try {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                }
            } catch (error) {
                addLog('‚úó Wake Lock-Fehler: ' + error.message);
            }
        }

        // ============ STATE ============
        let bleDevice = null;
        let txChar = null;
        let rxChar = null;
        let map = null;
        let marker = null;
        let currentData = {
            gps_lat: 46.8,
            gps_lon: 7.8,
            pitch: 0,
            roll: 0,
            heading: 0,
            v_speed: 0,
            v_min: 50,
            v_max: 500,
            tx_voltage: 0,
            altitude: 0,
            rx_voltage: 0,
            ddr_pitch: 0,
            ddr_roll: 0,
            expo_pitch: 0,
            expo_roll: 0,
            expo_throttle: 0,
            throttle_to_pitch: 0,
            trim_pitch: 0,
            trim_roll: 0,
            throttle_max: 0,
            throttle_min: 0
        };

        // ============ BLE FUNKTIONEN ============
        async function connectBLE() {
            try {
                addLog("Suche ESP32...");
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TxOneMove' }],
                    optionalServices: ['12345678-1234-5678-1234-56789abcdef0']
                });

                addLog("Verbinde zu " + bleDevice.name);
                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');

                txChar = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef1');
                rxChar = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef2');

                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', onTelemetryUpdate);

                updateStatus(true);
                addLog("‚úì Verbunden!");
            } catch (error) {
                addLog("‚úó Fehler: " + error.message);
            }
        }

        async function disconnectBLE() {
            if (bleDevice) {
                await bleDevice.gatt.disconnect();
                updateStatus(false);
                addLog("Getrennt");
                const container = document.getElementById('controlsContainer');
                container.innerHTML = '';
            }
        }

        async function resetTrim() {
            if (!rxChar) { 
                addLog("‚úó Nicht verbunden!"); 
                return; 
            }
            try {
                const cmd = { command: "RESET_TRIM" };
                const jsonStr = JSON.stringify(cmd);
                await rxChar.writeValue(new TextEncoder().encode(jsonStr));
                addLog("‚Üí RESET_TRIM gesendet!");
            } catch (error) {
                addLog("‚úó Reset-Fehler: " + error.message);
            }
        }

        function onTelemetryUpdate(e) {
            try {
                const jsonStr = new TextDecoder().decode(e.target.value.buffer);
                const data = JSON.parse(jsonStr);
                updateTelemetry(data);
            } catch (error) {
                addLog("Parse-Fehler: " + error.message);
            }
        }

        // ============ COMMAND QUEUE ============
        let commandQueue = [];
        let isSending = false;
        let debounceTimers = {};

        async function sendCommand(cmdJson) {
            if (!rxChar) { alert("Nicht verbunden!"); return; }
            commandQueue.push(cmdJson);
            if (!isSending) {
                processCommandQueue();
            }
        }

        async function processCommandQueue() {
            if (commandQueue.length === 0 || isSending) return;
            isSending = true;
            const cmd = commandQueue.shift();
            try {
                const jsonStr = JSON.stringify(cmd);
                await rxChar.writeValue(new TextEncoder().encode(jsonStr));
                addLog("‚Üí Gesendet: " + jsonStr);
            } catch (error) {
                addLog("‚úó Send-Fehler: " + error.message);
            }
            isSending = false;
            if (commandQueue.length > 0) {
                setTimeout(processCommandQueue, 50);
            }
        }

        function sendCommandDebounced(cmdJson, key) {
            if (debounceTimers[key]) {
                clearTimeout(debounceTimers[key]);
            }
            debounceTimers[key] = setTimeout(() => {
                sendCommand(cmdJson);
                delete debounceTimers[key];
            }, 200);
        }

        // ============ TELEMETRIE ============
        function updateTelemetry(data) {
            Object.assign(currentData, data);
            
            // *** VARIO-SOUND AKTUALISIEREN ***
            if (typeof data.v_speed !== 'undefined') {
                updateVarioSound(data.v_speed, data.v_min || currentData.v_min, data.v_max || currentData.v_max);
                
                // Update Vario Display in Topbar
                document.getElementById('varioSpeedDisplay').textContent = data.v_speed.toFixed(2);
                
                // Status f√ºr RX Telemetry
                let statusText = 'neutral';
                if (Math.abs(data.v_speed) >= 0) {
                    statusText = data.v_speed > 0 ? '‚Üó Steigt' : '‚Üò Sinkt';
                }
                
                updateTelemDisplay('v_speed', data.v_speed, 2, ' m/s');
                document.getElementById('telem-v_status').textContent = statusText;
            }
            
            map.setView([data.gps_lat || 46.8, data.gps_lon || 7.8], 16);
            marker.setLatLng([data.gps_lat || 46.8, data.gps_lon || 7.8]);
            const roll = data.roll_angle || 0;
            const pitch = data.pitch_angle || 0;
            document.getElementById('horizonNeedle').style.transform = 
                `rotateZ(${roll}deg) translateY(${pitch * 2}px)`;

            updateTelemDisplay('armed', data.armed, 1, '');
            updateTelemDisplay('tx_voltage', data.tx_voltage, 2, 'V');
            updateTelemDisplay('throttle_voltage', data.throttle_voltage, 2, 'V');
            updateTelemDisplay('pitch', data.pitch, 0, '%');
            updateTelemDisplay('roll', data.roll, 0, '%');
            updateTelemDisplay('throttle', data.throttle, 0, '%');
            updateTelemDisplay('trim_pitch', data.trim_pitch, 0, '%');
            updateTelemDisplay('trim_roll', data.trim_roll, 0, '%');
            updateTelemDisplay('lat', data.gps_lat, 6, '¬∞');
            updateTelemDisplay('lon', data.gps_lon, 6, '¬∞');
            updateTelemDisplay('gps_altitude', data.gps_altitude, 1, 'm');  
            updateTelemDisplay('heading', data.heading, 1, '¬∞');
            updateTelemDisplay('hdop', data.gps_hdop, 2, '');
            updateTelemDisplay('satellites', data.gps_satellites, 0, '');
            updateTelemDisplay('altitude', data.altitude, 1, 'm');
            updateTelemDisplay('max_altitude', data.max_altitude, 1, 'm');
            updateTelemDisplay('rx_voltage', data.rx_voltage, 2, 'V');
            updateParameterDisplay(data);
        }

        function updateTelemDisplay(key, value, decimal, unit = '') {
            const elem = document.getElementById('telem-' + key);
            if (elem) {
                elem.textContent = (typeof value === 'number') ? 
                    value.toFixed(decimal) + unit : '--';
            }
        }

        function updateParameterDisplay(data) {
            const container = document.getElementById('controlsContainer');
            if (container.children.length === 0) {
                buildControlUI(data);
            }
        }

        // ============ PARAMETER UI ============
        function buildControlUI(data) {
            const container = document.getElementById('controlsContainer');
            container.innerHTML = '';

            const fields = [
                { key: 'ddr_pitch', label: 'D/R Pitch [%]', type: 'range', min: 0, max: 100 },
                { key: 'ddr_roll', label: 'D/R Roll [%]', type: 'range', min: 0, max: 100 },
                { key: 'expo_pitch', label: 'Expo Pitch [%]', type: 'range', min: 0, max: 100 },
                { key: 'expo_roll', label: 'Expo Roll [%]', type: 'range', min: 0, max: 100 },
                { key: 'expo_throttle', label: 'Expo Throttle [%]', type: 'range', min: 0, max: 100 },
                { key: 'throttle_to_pitch', label: 'Throttle ‚Üí Pitch [%]', type: 'range', min: -100, max: 100 },
                { key: 'throttle_max', label: 'Throttle max [V]', type: 'number', min: 0, max: 3.3 },
                { key: 'throttle_min', label: 'Throttle min [V]', type: 'number', min: 0, max: 3.3 },
                { key: 'v_min', label: 'Vario Min [m/s]', type: 'number', min: 0, max: 2.0 },
                { key: 'v_max', label: 'Vario Max [m/s]', type: 'number', min: 2.0, max: 20.0 }
            ];

            fields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'control-group';
                const label = document.createElement('label');
                label.textContent = field.label;
                group.appendChild(label);

                if (field.type === 'number') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = field.min || 0;
                    input.max = field.max || 100;
                    input.step = '1';
                    input.value = data[field.key] || 0;
                    input.onchange = () => sendCommand({ [field.key]: parseFloat(input.value) });
                    group.appendChild(input);
                } else if (field.type === 'range') {
                    const input = document.createElement('input');
                    input.type = 'range';
                    input.min = field.min || 0;
                    input.max = field.max || 100;
                    input.value = data[field.key] || 0;
                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = input.value + '%';
                    valueSpan.style.fontSize = '12px';
                    valueSpan.style.marginTop = '4px';
                    valueSpan.style.display = 'block';
                    valueSpan.style.color = 'var(--muted)';
                    
                    input.oninput = () => {
                        valueSpan.textContent = input.value + '%';
                        sendCommandDebounced({ [field.key]: parseFloat(input.value) }, field.key);
                    };
                    group.appendChild(input);
                    group.appendChild(valueSpan);
                }
                container.appendChild(group);
            });
        }

        // ============ STATUS ============
        function updateStatus(connected) {
            const elem = document.getElementById('status');
            document.getElementById('connectBtn').style.display = connected ? 'none' : 'block';
            document.getElementById('disconnectBtn').style.display = connected ? 'block' : 'none';
            document.getElementById('resetTrimBtn').style.display = connected ? 'block' : 'none';
            
            if (connected) {
                elem.textContent = '‚úì Verbunden';
                elem.className = 'status connected';
            } else {
                elem.textContent = '‚úó Getrennt';
                elem.className = 'status disconnected';
            }
        }

        function addLog(msg) {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML = `[${timestamp}] ${msg}<br>` + log.innerHTML;
            if (log.children.length > 20) log.removeChild(log.lastChild);
        }

        async function saveParams() {
            if (!rxChar) { 
                addLog("‚úó Nicht verbunden!"); 
                return; 
            }
            try {
                const cmd = { command: "SAVE_PARAMS" };
                const jsonStr = JSON.stringify(cmd);
                await rxChar.writeValue(new TextEncoder().encode(jsonStr));
                addLog("‚Üí SAVE_PARAMS gesendet!");
            } catch (error) {
                addLog("‚úó Save-Fehler: " + error.message);
            }
        }

        // ============ INIT ============
        function initMap() {
            map = L.map('map').setView([46.8, 7.8], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            marker = L.marker([46.8, 7.8], { rotationAngle: 0 }).addTo(map);
            marker.bindPopup('Modellflieger');
            map.addControl(L.control.compass({ position: 'topright' }));
        }

        window.addEventListener('load', () => {
            initMap();
            addLog("WebApp bereit. Klicke 'Verbinden'");
        });
    </script>
</body>
</html>

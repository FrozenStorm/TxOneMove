<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TxOneMove Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ccc;
            display: inline-block;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .card h3 {
            color: #764ba2;
            font-size: 14px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 600;
            color: #555;
        }

        .data-value {
            color: #667eea;
            font-weight: 500;
            text-align: right;
        }

        .slider-group {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 5px;
            color: #555;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .input-group {
            margin: 12px 0;
            display: flex;
            gap: 10px;
        }

        input[type="text"], input[type="number"], select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #667eea;
            box-shadow: 0 0 3px rgba(102, 126, 234, 0.3);
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 5px 0;
        }

        button:hover {
            background: #764ba2;
        }

        button:active {
            transform: scale(0.98);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .channel-config {
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .channel-config-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .channel-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 8px;
            margin: 8px 0;
            font-size: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .orientation-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .orientation-btn {
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            color: #333;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .orientation-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .gps-indicator {
            padding: 12px;
            background: #f0f4ff;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 13px;
        }

        .gps-indicator.valid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .gps-indicator.invalid {
            background: #ffebee;
            color: #c62828;
        }

        .meter {
            margin: 12px 0;
        }

        .meter-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
            color: #555;
        }

        .meter-bar {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107);
            width: 0%;
            transition: width 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            font-weight: 600;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            color: #999;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .orientation-selector {
                grid-template-columns: 1fr;
            }

            .channel-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>TxOneMove <span class="status-indicator" id="statusIndicator"></span></h1>
                <p id="modelName" style="color: #999; font-size: 14px;">Modell: ---</p>
            </div>
            <div style="text-align: right;">
                <button onclick="saveParameters()">üíæ Speichern</button>
                <button onclick="resetTrim()">‚Ü∫ Trim zur√ºcksetzen</button>
            </div>
        </div>

        <!-- TELEMETRY SECTION -->
        <div class="grid">
            <!-- GPS & Location -->
            <div class="card">
                <h2>üìç GPS & Position</h2>
                <div class="data-row">
                    <span class="data-label">Latitude:</span>
                    <span class="data-value" id="gpsLat">0.0000</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Longitude:</span>
                    <span class="data-value" id="gpsLon">0.0000</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Speed (km/h):</span>
                    <span class="data-value" id="gpsSpeed">0.00</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Altitude (m):</span>
                    <span class="data-value" id="gpsAltitude">0.00</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Satellites:</span>
                    <span class="data-value" id="gpsSatellites">0</span>
                </div>
                <div id="gpsStatus" class="gps-indicator invalid">
                    ‚ùå Kein GPS-Signal
                </div>
            </div>

            <!-- Attitude & Angles -->
            <div class="card">
                <h2>üéØ Attitude & Angles</h2>
                <div class="data-row">
                    <span class="data-label">Pitch Angle:</span>
                    <span class="data-value" id="pitchAngle">0.0¬∞</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Roll Angle:</span>
                    <span class="data-value" id="rollAngle">0.0¬∞</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Pitch (Function):</span>
                    <span class="data-value" id="funcPitch">0%</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Roll (Function):</span>
                    <span class="data-value" id="funcRoll">0%</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Heading:</span>
                    <span class="data-value" id="heading">0¬∞</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Armed:</span>
                    <span class="data-value" id="armed">‚ùå</span>
                </div>
            </div>

            <!-- V-Tail Control -->
            <div class="card">
                <h2>üõ©Ô∏è V-Tail Control</h2>
                <div class="data-row">
                    <span class="data-label">V-Tail Left:</span>
                    <span class="data-value" id="vtailLeft">0%</span>
                </div>
                <div class="data-row">
                    <span class="data-label">V-Tail Right:</span>
                    <span class="data-value" id="vtailRight">0%</span>
                </div>
                <div class="meter">
                    <div class="meter-label">
                        <span>V-Tail Left</span>
                        <span id="vtailLeftPercent">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="vtailLeftBar"></div>
                    </div>
                </div>
                <div class="meter">
                    <div class="meter-label">
                        <span>V-Tail Right</span>
                        <span id="vtailRightPercent">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="vtailRightBar"></div>
                    </div>
                </div>
            </div>

            <!-- Power & Voltage -->
            <div class="card">
                <h2>üîã Power & Voltage</h2>
                <div class="data-row">
                    <span class="data-label">TX Voltage:</span>
                    <span class="data-value" id="txVoltage">0.0V</span>
                </div>
                <div class="data-row">
                    <span class="data-label">RX Voltage:</span>
                    <span class="data-value" id="rxVoltage">0.0V</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Throttle Voltage:</span>
                    <span class="data-value" id="throttleVoltage">0.0V</span>
                </div>
                <div class="meter">
                    <div class="meter-label">
                        <span>TX Battery</span>
                        <span id="txVoltagePercent">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="txVoltageMeter"></div>
                    </div>
                </div>
                <div class="meter">
                    <div class="meter-label">
                        <span>RX Battery</span>
                        <span id="rxVoltagePercent">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="rxVoltageMeter"></div>
                    </div>
                </div>
            </div>

            <!-- Throttle & Control -->
            <div class="card">
                <h2>‚öôÔ∏è Control Values</h2>
                <div class="data-row">
                    <span class="data-label">Throttle:</span>
                    <span class="data-value" id="throttle">0%</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Trim Pitch:</span>
                    <span class="data-value" id="trimPitch">0%</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Trim Roll:</span>
                    <span class="data-value" id="trimRoll">0%</span>
                </div>
                <div class="meter">
                    <div class="meter-label">
                        <span>Throttle</span>
                        <span id="throttlePercent">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="throttleMeter"></div>
                    </div>
                </div>
            </div>

            <!-- Orientation -->
            <div class="card">
                <h2>üß≠ Orientation</h2>
                <div class="data-row">
                    <span class="data-label">Current Orientation:</span>
                    <span class="data-value" id="orientationValue">UNKNOWN</span>
                </div>
                <div class="orientation-selector" id="orientationSelector">
                    <!-- Wird dynamisch mit JavaScript gef√ºllt -->
                </div>
            </div>
        </div>

        <!-- CONFIGURATION SECTION -->
        <div class="grid full-width">
            <div class="card">
                <h2>‚öôÔ∏è Konfiguration</h2>
                
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab(event, 'trimTab')">Trim</button>
                    <button class="tab-button" onclick="switchTab(event, 'ratesTab')">Raten</button>
                    <button class="tab-button" onclick="switchTab(event, 'channelsTab')">Kan√§le</button>
                    <button class="tab-button" onclick="switchTab(event, 'modelTab')">Modell</button>
                </div>

                <!-- TRIM TAB -->
                <div id="trimTab" class="tab-content active">
                    <h3>Trim-Einstellungen</h3>
                    
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Trim Pitch</span>
                            <span id="trimPitchDisplay">0%</span>
                        </div>
                        <input type="range" id="trimPitchSlider" min="-100" max="100" value="0" 
                            oninput="updateTrimPitch(this.value)">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Trim Roll</span>
                            <span id="trimRollDisplay">0%</span>
                        </div>
                        <input type="range" id="trimRollSlider" min="-100" max="100" value="0"
                            oninput="updateTrimRoll(this.value)">
                    </div>
                </div>

                <!-- RATES TAB -->
                <div id="ratesTab" class="tab-content">
                    <h3>Dual Rate</h3>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Pitch Dual Rate</span>
                            <span id="ddrPitchDisplay">100%</span>
                        </div>
                        <input type="range" id="ddrPitchSlider" min="0" max="200" value="100"
                            oninput="updateDDRPitch(this.value)">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Roll Dual Rate</span>
                            <span id="ddrRollDisplay">100%</span>
                        </div>
                        <input type="range" id="ddrRollSlider" min="0" max="200" value="100"
                            oninput="updateDDRRoll(this.value)">
                    </div>

                    <h3>Exponential</h3>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Pitch Expo</span>
                            <span id="expoPitchDisplay">0%</span>
                        </div>
                        <input type="range" id="expoPitchSlider" min="0" max="100" value="0"
                            oninput="updateExpoPitch(this.value)">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Roll Expo</span>
                            <span id="expoRollDisplay">0%</span>
                        </div>
                        <input type="range" id="expoRollSlider" min="0" max="100" value="0"
                            oninput="updateExpoRoll(this.value)">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Throttle Expo</span>
                            <span id="expoThrottleDisplay">0%</span>
                        </div>
                        <input type="range" id="expoThrottleSlider" min="0" max="100" value="0"
                            oninput="updateExpoThrottle(this.value)">
                    </div>

                    <h3>Mixer</h3>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Throttle to Pitch</span>
                            <span id="throttleToPitchDisplay">0%</span>
                        </div>
                        <input type="range" id="throttleToPitchSlider" min="0" max="100" value="0"
                            oninput="updateThrottleToPitch(this.value)">
                    </div>

                    <h3>Drosselklappenbereich</h3>
                    <div class="input-group">
                        <label>Min:</label>
                        <input type="number" id="throttleMinInput" min="0" max="100" value="0"
                            onchange="updateThrottleMin(this.value)">
                    </div>
                    <div class="input-group">
                        <label>Max:</label>
                        <input type="number" id="throttleMaxInput" min="0" max="100" value="100"
                            onchange="updateThrottleMax(this.value)">
                    </div>
                </div>

                <!-- CHANNELS TAB -->
                <div id="channelsTab" class="tab-content">
                    <h3>Funktions-zu-Kanal-Zuordnung</h3>
                    <div id="channelConfigs">
                        <!-- Wird dynamisch mit JavaScript gef√ºllt -->
                    </div>
                </div>

                <!-- MODEL TAB -->
                <div id="modelTab" class="tab-content">
                    <h3>Modelleinstellungen</h3>
                    <div class="input-group">
                        <label>Modellname:</label>
                        <input type="text" id="modelNameInput" maxlength="12" value="123456789_12"
                            onchange="updateModelName(this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- CHANNELS DATA -->
        <div class="card full-width">
            <h2>üìä Rohdaten Kan√§le (PPM)</h2>
            <div id="channelsDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                <!-- Wird dynamisch mit JavaScript gef√ºllt -->
            </div>
        </div>
    </div>

    <script>
        let bluetoothDevice = null;
        let characteristic = null;
        let radioData = {
            armed: false,
            gpsLat: 0,
            gpsLon: 0,
            gpsSpeed: 0,
            gpsAltitude: 0,
            gpsSatellites: 0,
            pitchAngle: 0,
            rollAngle: 0,
            funcPitch: 0,
            funcRoll: 0,
            heading: 0,
            txVoltage: 0,
            rxVoltage: 0,
            throttleVoltage: 0,
            trimPitch: 0,
            trimRoll: 0,
            throttle: 0,
            ddrPitch: 100,
            ddrRoll: 100,
            expoPitch: 0,
            expoRoll: 0,
            expoThrottle: 0,
            throttleToPitch: 0,
            throttleMin: 0,
            throttleMax: 100,
            modelName: "123456789_12",
            orientation: 0,
            orientationNames: ["UNKNOWN", "T_UP", "T_LEFT", "T_RIGHT", "T_LEFT_DOWN", "T_LEFT_UP", "T_DOWN"],
            functionNames: ["NONE", "PITCH", "ROLL", "VTAIL_LEFT", "VTAIL_RIGHT", "THROTTLE"],
            vtailLeft: 0,
            vtailRight: 0,
            channels: new Array(16).fill(992),
            functionToChannel: {},
            ftc: {}
        };

        // Initialize channel configs
        function initializeChannelConfigs() {
            for (let i = 0; i < 8; i++) {
                radioData.functionToChannel[i] = {
                    invert: false,
                    func: 0,
                    upper: 1811,
                    lower: 172
                };
            }
            renderChannelConfigs();
            renderOrientationSelector();
        }

        // Render channel configuration UI
        function renderChannelConfigs() {
            const container = document.getElementById('channelConfigs');
            container.innerHTML = '';
            
            for (let ch = 0; ch < 8; ch++) {
                const config = radioData.functionToChannel[ch] || {};
                const html = `
                    <div class="channel-config">
                        <div class="channel-config-title">Kanal ${ch + 1}</div>
                        <div class="channel-row">
                            <select id="func_${ch}" onchange="updateChannelFunction(${ch}, this.value)">
                                ${radioData.functionNames.map((name, idx) => 
                                    `<option value="${idx}" ${config.func === idx ? 'selected' : ''}>${name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="invert_${ch}" 
                                ${config.invert ? 'checked' : ''} 
                                onchange="updateChannelInvert(${ch}, this.checked)">
                            <label for="invert_${ch}">Invertieren</label>
                        </div>
                        <div class="channel-row">
                            <label>Ober:</label>
                            <input type="number" id="upper_${ch}" value="${config.upper}" 
                                onchange="updateChannelUpper(${ch}, this.value)" style="flex: 1;">
                        </div>
                        <div class="channel-row">
                            <label>Unter:</label>
                            <input type="number" id="lower_${ch}" value="${config.lower}" 
                                onchange="updateChannelLower(${ch}, this.value)" style="flex: 1;">
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }
        }

        // Render orientation selector
        function renderOrientationSelector() {
            const container = document.getElementById('orientationSelector');
            container.innerHTML = radioData.orientationNames
                .map((name, idx) => `
                    <button class="orientation-btn ${radioData.orientation === idx ? 'active' : ''}" 
                        onclick="updateOrientation(${idx})">
                        ${name}
                    </button>
                `)
                .join('');
        }

        // Tab switching
        function switchTab(event, tabId) {
            event.preventDefault();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Update functions for trim
        function updateTrimPitch(value) {
            document.getElementById('trimPitchDisplay').textContent = value + '%';
            sendData({ trim_pitch: value });
        }

        function updateTrimRoll(value) {
            document.getElementById('trimRollDisplay').textContent = value + '%';
            sendData({ trim_roll: value });
        }

        // Update functions for DDR
        function updateDDRPitch(value) {
            document.getElementById('ddrPitchDisplay').textContent = value + '%';
            sendData({ ddr_pitch: value });
        }

        function updateDDRRoll(value) {
            document.getElementById('ddrRollDisplay').textContent = value + '%';
            sendData({ ddr_roll: value });
        }

        // Update functions for Expo
        function updateExpoPitch(value) {
            document.getElementById('expoPitchDisplay').textContent = value + '%';
            sendData({ expo_pitch: value });
        }

        function updateExpoRoll(value) {
            document.getElementById('expoRollDisplay').textContent = value + '%';
            sendData({ expo_roll: value });
        }

        function updateExpoThrottle(value) {
            document.getElementById('expoThrottleDisplay').textContent = value + '%';
            sendData({ expo_throttle: value });
        }

        // Update Throttle to Pitch
        function updateThrottleToPitch(value) {
            document.getElementById('throttleToPitchDisplay').textContent = value + '%';
            sendData({ throttle_to_pitch: value });
        }

        // Update throttle limits
        function updateThrottleMin(value) {
            sendData({ throttle_min: value });
        }

        function updateThrottleMax(value) {
            sendData({ throttle_max: value });
        }

        // Channel functions
        function updateChannelFunction(ch, value) {
            if (!radioData.functionToChannel[ch]) radioData.functionToChannel[ch] = {};
            radioData.functionToChannel[ch].func = parseInt(value);
            sendChannelConfig(ch);
        }

        function updateChannelInvert(ch, checked) {
            if (!radioData.functionToChannel[ch]) radioData.functionToChannel[ch] = {};
            radioData.functionToChannel[ch].invert = checked;
            sendChannelConfig(ch);
        }

        function updateChannelUpper(ch, value) {
            if (!radioData.functionToChannel[ch]) radioData.functionToChannel[ch] = {};
            radioData.functionToChannel[ch].upper = parseInt(value);
            sendChannelConfig(ch);
        }

        function updateChannelLower(ch, value) {
            if (!radioData.functionToChannel[ch]) radioData.functionToChannel[ch] = {};
            radioData.functionToChannel[ch].lower = parseInt(value);
            sendChannelConfig(ch);
        }

        // Model name
        function updateModelName(value) {
            sendData({ model_name: value });
        }

        // Orientation
        function updateOrientation(idx) {
            radioData.orientation = idx;
            renderOrientationSelector();
            sendData({ orientation: idx });
        }

        // Send channel config
        function sendChannelConfig(ch) {
            const ftc = {};
            for (let i = 0; i < 8; i++) {
                if (radioData.functionToChannel[i]) {
                    const cfg = radioData.functionToChannel[i];
                    ftc['ch' + i] = {
                        invert: cfg.invert,
                        func: cfg.func,
                        upper: cfg.upper,
                        lower: cfg.lower
                    };
                }
            }
            sendData({ ftc: ftc });
        }

        // Generic send data
        function sendData(data) {
            if (!characteristic) return;
            const json = JSON.stringify(data);
            const encoder = new TextEncoder();
            characteristic.writeValue(encoder.encode(json));
        }

        // Save parameters
        function saveParameters() {
            sendData({ command: 'SAVE_PARAMS' });
            alert('Parameter werden gespeichert...');
        }

        // Reset trim
        function resetTrim() {
            if (confirm('Trim wirklich zur√ºcksetzen?')) {
                sendData({ command: 'RESET_TRIM' });
                document.getElementById('trimPitchSlider').value = 0;
                document.getElementById('trimRollSlider').value = 0;
                document.getElementById('trimPitchDisplay').textContent = '0%';
                document.getElementById('trimRollDisplay').textContent = '0%';
            }
        }

        // Update UI with received data
        function updateUI(data) {
            if (data.armed !== undefined) radioData.armed = data.armed;
            if (data.gps_lat !== undefined) radioData.gpsLat = data.gps_lat;
            if (data.gps_lon !== undefined) radioData.gpsLon = data.gps_lon;
            if (data.gps_speed !== undefined) radioData.gpsSpeed = data.gps_speed;
            if (data.gps_altitude !== undefined) radioData.gpsAltitude = data.gps_altitude;
            if (data.gps_satellites !== undefined) radioData.gpsSatellites = data.gps_satellites;
            if (data.pitch_angle !== undefined) radioData.pitchAngle = data.pitch_angle;
            if (data.roll_angle !== undefined) radioData.rollAngle = data.roll_angle;
            if (data.pitch !== undefined) radioData.funcPitch = data.pitch / 100;
            if (data.roll !== undefined) radioData.funcRoll = data.roll / 100;
            if (data.heading !== undefined) radioData.heading = data.heading;
            if (data.tx_voltage !== undefined) radioData.txVoltage = data.tx_voltage;
            if (data.rx_voltage !== undefined) radioData.rxVoltage = data.rx_voltage;
            if (data.throttle_voltage !== undefined) radioData.throttleVoltage = data.throttle_voltage;
            if (data.trim_pitch !== undefined) {
                radioData.trimPitch = data.trim_pitch / 100;
                document.getElementById('trimPitchSlider').value = data.trim_pitch / 100;
                document.getElementById('trimPitchDisplay').textContent = Math.round(data.trim_pitch / 100) + '%';
            }
            if (data.trim_roll !== undefined) {
                radioData.trimRoll = data.trim_roll / 100;
                document.getElementById('trimRollSlider').value = data.trim_roll / 100;
                document.getElementById('trimRollDisplay').textContent = Math.round(data.trim_roll / 100) + '%';
            }
            if (data.throttle !== undefined) radioData.throttle = data.throttle / 100;
            if (data.ddr_pitch !== undefined) {
                radioData.ddrPitch = data.ddr_pitch;
                document.getElementById('ddrPitchSlider').value = data.ddr_pitch;
                document.getElementById('ddrPitchDisplay').textContent = Math.round(data.ddr_pitch) + '%';
            }
            if (data.ddr_roll !== undefined) {
                radioData.ddrRoll = data.ddr_roll;
                document.getElementById('ddrRollSlider').value = data.ddr_roll;
                document.getElementById('ddrRollDisplay').textContent = Math.round(data.ddr_roll) + '%';
            }
            if (data.expo_pitch !== undefined) {
                radioData.expoPitch = data.expo_pitch;
                document.getElementById('expoPitchSlider').value = data.expo_pitch;
                document.getElementById('expoPitchDisplay').textContent = Math.round(data.expo_pitch) + '%';
            }
            if (data.expo_roll !== undefined) {
                radioData.expoRoll = data.expo_roll;
                document.getElementById('expoRollSlider').value = data.expo_roll;
                document.getElementById('expoRollDisplay').textContent = Math.round(data.expo_roll) + '%';
            }
            if (data.expo_throttle !== undefined) {
                radioData.expoThrottle = data.expo_throttle;
                document.getElementById('expoThrottleSlider').value = data.expo_throttle;
                document.getElementById('expoThrottleDisplay').textContent = Math.round(data.expo_throttle) + '%';
            }
            if (data.throttle_to_pitch !== undefined) {
                radioData.throttleToPitch = data.throttle_to_pitch;
                document.getElementById('throttleToPitchSlider').value = data.throttle_to_pitch;
                document.getElementById('throttleToPitchDisplay').textContent = Math.round(data.throttle_to_pitch) + '%';
            }
            if (data.throttle_min !== undefined) {
                radioData.throttleMin = data.throttle_min;
                document.getElementById('throttleMinInput').value = data.throttle_min;
            }
            if (data.throttle_max !== undefined) {
                radioData.throttleMax = data.throttle_max;
                document.getElementById('throttleMaxInput').value = data.throttle_max;
            }
            if (data.model_name !== undefined) {
                radioData.modelName = data.model_name;
                document.getElementById('modelNameInput').value = data.model_name;
                document.getElementById('modelName').textContent = 'Modell: ' + data.model_name;
            }
            if (data.orientation !== undefined) {
                radioData.orientation = data.orientation;
                renderOrientationSelector();
            }
            if (data.orientation_names) {
                radioData.orientationNames = data.orientation_names;
            }
            if (data.func_names) {
                radioData.functionNames = data.func_names;
                renderChannelConfigs();
            }
            if (data.ftc) {
                for (const key in data.ftc) {
                    const ch = parseInt(key.replace('ch', ''));
                    radioData.functionToChannel[ch] = data.ftc[key];
                }
                renderChannelConfigs();
            }
            if (data.channels) {
                radioData.channels = data.channels;
                renderChannels();
            }
            if (data.vtail_left !== undefined) radioData.vtailLeft = data.vtail_left / 100;
            if (data.vtail_right !== undefined) radioData.vtailRight = data.vtail_right / 100;

            renderDisplay();
        }

        function renderDisplay() {
            // GPS
            document.getElementById('gpsLat').textContent = radioData.gpsLat.toFixed(4);
            document.getElementById('gpsLon').textContent = radioData.gpsLon.toFixed(4);
            document.getElementById('gpsSpeed').textContent = radioData.gpsSpeed.toFixed(2);
            document.getElementById('gpsAltitude').textContent = radioData.gpsAltitude.toFixed(2);
            document.getElementById('gpsSatellites').textContent = radioData.gpsSatellites;

            const gpsStatus = document.getElementById('gpsStatus');
            if (radioData.gpsSatellites > 3) {
                gpsStatus.classList.add('valid');
                gpsStatus.classList.remove('invalid');
                gpsStatus.innerHTML = '‚úÖ GPS-Signal g√ºltig (' + radioData.gpsSatellites + ' Sat.)';
            } else {
                gpsStatus.classList.remove('valid');
                gpsStatus.classList.add('invalid');
                gpsStatus.innerHTML = '‚ùå Kein GPS-Signal';
            }

            // Attitude
            document.getElementById('pitchAngle').textContent = radioData.pitchAngle.toFixed(1) + '¬∞';
            document.getElementById('rollAngle').textContent = radioData.rollAngle.toFixed(1) + '¬∞';
            document.getElementById('funcPitch').textContent = radioData.funcPitch.toFixed(0) + '%';
            document.getElementById('funcRoll').textContent = radioData.funcRoll.toFixed(0) + '%';
            document.getElementById('heading').textContent = radioData.heading.toFixed(0) + '¬∞';
            document.getElementById('armed').textContent = radioData.armed ? '‚úÖ' : '‚ùå';

            // V-Tail
            document.getElementById('vtailLeft').textContent = radioData.vtailLeft.toFixed(0) + '%';
            document.getElementById('vtailRight').textContent = radioData.vtailRight.toFixed(0) + '%';
            document.getElementById('vtailLeftPercent').textContent = radioData.vtailLeft.toFixed(0) + '%';
            document.getElementById('vtailRightPercent').textContent = radioData.vtailRight.toFixed(0) + '%';
            updateMeterBar('vtailLeftBar', radioData.vtailLeft);
            updateMeterBar('vtailRightBar', radioData.vtailRight);

            // Power
            document.getElementById('txVoltage').textContent = radioData.txVoltage.toFixed(1) + 'V';
            document.getElementById('rxVoltage').textContent = radioData.rxVoltage.toFixed(1) + 'V';
            document.getElementById('throttleVoltage').textContent = radioData.throttleVoltage.toFixed(1) + 'V';
            updateMeterBar('txVoltageMeter', Math.min(radioData.txVoltage * 20, 100));
            updateMeterBar('rxVoltageMeter', Math.min(radioData.rxVoltage * 20, 100));

            // Throttle
            document.getElementById('throttle').textContent = radioData.throttle.toFixed(0) + '%';
            document.getElementById('throttlePercent').textContent = radioData.throttle.toFixed(0) + '%';
            updateMeterBar('throttleMeter', radioData.throttle);

            // Trim
            document.getElementById('trimPitch').textContent = radioData.trimPitch.toFixed(0) + '%';
            document.getElementById('trimRoll').textContent = radioData.trimRoll.toFixed(0) + '%';

            // Orientation
            document.getElementById('orientationValue').textContent = radioData.orientationNames[radioData.orientation] || 'UNKNOWN';
        }

        function updateMeterBar(elementId, percentage) {
            const bar = document.getElementById(elementId);
            if (bar) {
                const clamped = Math.max(0, Math.min(100, percentage));
                bar.style.width = clamped + '%';
                bar.textContent = clamped.toFixed(0) + '%';
            }
        }

        function renderChannels() {
            const container = document.getElementById('channelsDisplay');
            container.innerHTML = radioData.channels.map((ch, idx) => `
                <div style="background: #f0f4ff; padding: 12px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 4px;">Ch ${idx + 1}</div>
                    <div style="font-size: 16px; font-weight: 600; color: #667eea;">${ch}</div>
                    <div style="font-size: 10px; color: #999;">¬µs</div>
                </div>
            `).join('');
        }

        // Connection status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            if (connected) {
                indicator.classList.add('connected');
            } else {
                indicator.classList.remove('connected');
            }
        }

        // Mock data for testing
        function simulateData() {
            updateUI({
                armed: true,
                gps_lat: 47.3245,
                gps_lon: 8.5452,
                gps_speed: 12.5,
                gps_altitude: 850.25,
                gps_satellites: 8,
                pitch_angle: 5.2,
                roll_angle: -2.1,
                pitch: 2500,
                roll: -1500,
                heading: 125,
                tx_voltage: 4.8,
                rx_voltage: 5.1,
                throttle_voltage: 5.0,
                trim_pitch: 200,
                trim_roll: -150,
                throttle: 4500,
                ddr_pitch: 8000,
                ddr_roll: 8500,
                expo_pitch: 1500,
                expo_roll: 1200,
                expo_throttle: 800,
                throttle_to_pitch: 500,
                throttle_min: 10,
                throttle_max: 95,
                model_name: "Test Plane",
                orientation: 1,
                vtail_left: 4000,
                vtail_right: 3800,
                channels: [992, 1000, 1050, 950, 992, 992, 992, 992, 992, 992, 992, 992, 992, 992, 992, 992],
                func_names: ["NONE", "PITCH", "ROLL", "VTAIL_LEFT", "VTAIL_RIGHT", "THROTTLE"],
                orientation_names: ["UNKNOWN", "T_UP", "T_LEFT", "T_RIGHT", "T_LEFT_DOWN", "T_LEFT_UP", "T_DOWN"],
                ftc: {
                    ch0: { invert: false, func: 1, upper: 1811, lower: 172 },
                    ch1: { invert: false, func: 2, upper: 1811, lower: 172 },
                    ch2: { invert: false, func: 3, upper: 1811, lower: 172 },
                    ch3: { invert: false, func: 4, upper: 1811, lower: 172 },
                    ch4: { invert: false, func: 6, upper: 1811, lower: 172 },
                    ch5: { invert: false, func: 0, upper: 1811, lower: 172 },
                    ch6: { invert: false, func: 0, upper: 1811, lower: 172 },
                    ch7: { invert: false, func: 0, upper: 1811, lower: 172 }
                }
            });
            updateConnectionStatus(true);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            initializeChannelConfigs();
            simulateData(); // Demo mode
        });
    </script>
</body>
</html>
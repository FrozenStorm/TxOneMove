<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Hello World</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .panel {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
        }
        button {
            padding: 12px 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 0;
            width: 100%;
        }
        button:hover { background: #1976D2; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status {
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .status.connected {
            background: #E8F5E9;
            color: #4CAF50;
        }
        .status.disconnected {
            background: #FFEBEE;
            color: #F44336;
        }
        .response {
            padding: 15px;
            background: #E3F2FD;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
            margin-top: 10px;
            font-family: monospace;
            min-height: 40px;
            display: none;
        }
        .response.show {
            display: block;
        }
        .response-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .response-text {
            font-size: 18px;
            color: #1976D2;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”µ BLE Hello World</h1>
        
        <div class="status disconnected" id="status">Getrennt</div>
        
        <div class="panel">
            <button onclick="connectBLE()" id="connectBtn">Verbinden</button>
            <button onclick="disconnectBLE()" id="disconnectBtn" style="display: none;">Trennen</button>
        </div>

        <div class="panel">
            <button onclick="sendHelloWorld()" id="sendBtn" disabled>Sende "Hallo Welt"</button>
        </div>

        <div class="response" id="response">
            <div class="response-label">ESP32 Antwort:</div>
            <div class="response-text" id="responseText">--</div>
        </div>

        <div class="panel">
            <div style="font-size: 12px; color: #666;">
                <strong>Anleitung:</strong><br>
                1. Klicke "Verbinden" um den ESP32 zu finden<br>
                2. Klicke "Sende Hallo Welt" um Text zu versenden<br>
                3. ESP32 antwortet mit "Wie gehts?"
            </div>
        </div>
    </div>

    <script>
        let bleDevice = null;
        let txChar = null;
        let rxChar = null;

        async function connectBLE() {
            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TxOneMove' }],
                    optionalServices: ['12345678-1234-5678-1234-56789abcdef0']
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');

                txChar = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef1');
                rxChar = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef2');

                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', onDataReceived);

                updateUI(true);
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function disconnectBLE() {
            if (bleDevice) {
                await bleDevice.gatt.disconnect();
                updateUI(false);
            }
        }

        async function sendHelloWorld() {
            if (!rxChar) return;
            try {
                const message = "Hallo Welt 123456789 123456789 123456789 123456789 123456789 123456789 9999999999";
                await rxChar.writeValue(new TextEncoder().encode(message));
            } catch (error) {
                alert('Send-Fehler: ' + error.message);
            }
        }

        function onDataReceived(e) {
            const text = new TextDecoder().decode(e.target.value.buffer);
            showResponse(text);
        }

        function showResponse(text) {
            const responseDiv = document.getElementById('response');
            const responseText = document.getElementById('responseText');
            responseText.textContent = text;
            responseDiv.classList.add('show');
        }

        function updateUI(connected) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendBtn = document.getElementById('sendBtn');

            if (connected) {
                status.textContent = 'âœ“ Verbunden';
                status.className = 'status connected';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                sendBtn.disabled = false;
            } else {
                status.textContent = 'âœ— Getrennt';
                status.className = 'status disconnected';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                sendBtn.disabled = true;
                document.getElementById('response').classList.remove('show');
            }
        }
    </script>
</body>
</html>